# 通用生图插件 (Image Generation)

![:name](https://count.getloli.com/@astrbot_plugin_image_generation?name=astrbot_plugin_image_generation&theme=miku&padding=7&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

### 支持多种主流生图接口的通用图像生成插件，支持文生图、图生图、LLM 自动调用及强大的预设系统。

***

### 命令
- `/生图 <提示词或预设名称> [额外提示词]`
  - 生成图片。示例: `/生图 一只可爱的小猫`
  - 使用预设。示例: `/生图 动漫风`
  - 使用预设并附加额外提示词。示例: `/生图 动漫风 蓝色头发`
  - **图生图模式**：如果消息中包含图片、引用包含图片的消息，或 @ 用户，将自动作为参考图进入图生图模式（需适配器支持）。
  - @ 用户时会获取其头像作为参考图。示例: `/生图 像素风 @用户A`

- `/生图模型`
  - 显示可用模型列表和当前使用的模型。模型格式为 `供应商名称/模型名称`。
  - `/生图模型 <序号>` - 切换到指定序号的模型。

- `/预设`
  - 显示所有预设列表。
  - `/预设 添加 <预设名:预设内容>` - 添加新预设。
  - `/预设 删除 <预设名>` - 删除指定预设。

### 功能特性

- ✅ **多供应商配置**：支持配置多个生图服务供应商，每个供应商可拥有独立的 API Key、Base URL 及模型列表。
- ✅ **模型动态切换**：通过指令实时查看和在不同供应商的模型间切换。
- ✅ **供应商/模型体系**：采用 `供应商名称/模型名称` 的统一标识体系。
- ✅ **文生图**：根据文字描述生成图片。
- ✅ **图生图**：基于参考图片（支持多张）生成新图片，支持自动识别消息图片、引用图片及 @ 用户头像。
- ✅ **LLM 集成**：支持作为工具被 LLM 自动调用，实现对话式生图。
- ✅ **高级预设系统**：支持预定义提示词模板，预设内容支持 JSON 格式以配置特定比例和分辨率。
- ✅ **多 API Key 轮询**：支持配置多个 API Key，自动轮询与错误重试，提高稳定性。
- ✅ **完善的控制**：支持并发任务限制、用户频率限制（Rate Limit）及每日生图数量限制。

### 适配器支持状态

| 适配器类型      | 文生图 | 图生图 | 分辨率 | 宽高比 | 说明                                                                  |
| :-------------- | :----: | :----: | :----: | :----: | :-------------------------------------------------------------------- |
| `gemini`        |   ✅    |   ✅    |   ✅    |   ✅    | Gemini 原生 API                                                       |
| `gemini_openai` |   ✅    |   ✅    |   ❌    |   ❌    | OpenAI 兼容格式的 Gemini 接口                                         |
| `openai`        |   ✅    |   ❌    |   ❌    |   ✅    | OpenAI DALL-E 3                                                       |
| `z_image_gitee` |   ✅    |   ❌    |   ✅    |   ✅    | Gitee AI (z-image-turbo)                                              |
| `jimeng2api`    |   ✅    |   ✅    |   ✅    |   ✅    | 适用于[iptag/jimeng-api](https://github.com/iptag/jimeng-api)的适配器 |
持续更新中······
#### 特殊说明
  - 配置了jimeng2api的话，会在每次启动时和每天凌晨自动领取积分(仅限直接连接即梦逆向,中转途径没有对应接口)
  - jimeng逆向使用了/v1/images/compositions接口,使用中转会导致图生图失败
#### 欢迎提交 Issue/PR 添加新的适配器类型

### 配置项

#### 基础配置
| 配置项            | 类型    | 默认值 | 说明                                  |
| :---------------- | :------ | :----- | :------------------------------------ |
| `enable_llm_tool` | boolean | `true` | 是否允许 LLM 在对话中自动调用生图功能 |

#### API 供应商配置 (`api_providers`)
支持配置多个供应商，每个供应商项包含：
| 配置项             | 类型   | 说明                                                                 |
| :----------------- | :----- | :------------------------------------------------------------------- |
| `name`             | string | 适配器名称，用于区分不同供应商。生图模型格式为 `适配器名称/模型名称` |
| `base_url`         | string | API Base URL                                                         |
| `proxy`            | string | 代理地址，例如 `http://127.0.0.1:7890`                               |
| `api_keys`         | list   | API Keys 列表                                                        |
| `available_models` | list   | 可用模型列表，用于 `/生图模型` 命令切换                              |

#### 生成行为配置 (`generation`)
| 配置项                 | 类型    | 默认值   | 说明                                                                                                       |
| :--------------------- | :------ | :------- | :--------------------------------------------------------------------------------------------------------- |
| `model`                | string  | `""`     | 当前使用的模型，格式为 `供应商名称/模型名称`，不填写默认使用第一个可用模型，可以通过使用`生图模型`指令更新 |
| `timeout`              | number  | `180`    | 请求超时时间（秒）。                                                                                       |
| `max_retry_attempts`   | number  | `3`      | 最大重试次数。                                                                                             |
| `max_concurrent_tasks` | number  | `3`      | 最大并发生图任务数，防止资源耗尽。                                                                         |
| `default_aspect_ratio` | string  | `"自动"` | 默认图片宽高比。可选值：`自动`、`1:1`、`2:3`、`3:2`、`3:4`、`4:3`、`4:5`、`5:4`、`9:16`、`16:9`、`21:9`。  |
| `default_resolution`   | string  | `"1K"`   | 默认分辨率（仅部分模型支持）。可选值：`1K`、`2K`、`4K`。                                                   |
| `show_generation_info` | boolean | `false`  | 生图成功后展示生图耗时和数量。                                                                             |
| `show_model_info`      | boolean | `false`  | 生图成功后展示所使用的模型名称。                                                                           |

#### 用户限制配置 (`user_limits`)
| 配置项               | 类型    | 默认值  | 说明                                                       |
| :------------------- | :------ | :------ | :--------------------------------------------------------- |
| `rate_limit_seconds` | number  | `0`     | 单个用户两次请求之间的最小间隔时间（秒），0 表示不限制。   |
| `max_image_size_mb`  | number  | `10`    | 允许上传的参考图最大大小（MB），超过此大小的图片将被忽略。 |
| `enable_daily_limit` | boolean | `false` | 是否启用每日生图数量限制。                                 |
| `daily_limit_count`  | number  | `10`    | 每个用户每日允许生成的最大图片数量。                       |

#### 缓存配置 (`cache`)
| 配置项                   | 类型   | 默认值 | 说明                                       |
| :----------------------- | :----- | :----- | :----------------------------------------- |
| `max_cache_count`        | number | `100`  | 最大缓存图片数量，超过此数量将清理旧图片。 |
| `cleanup_interval_hours` | number | `24`   | 定时清理间隔（小时）。                     |

#### 预设配置 (`presets`)
| 配置项    | 类型 | 默认值           | 说明                                       |
| :-------- | :--- | :--------------- | :----------------------------------------- |
| `presets` | list | 包含多个内置预设 | 预定义的图片生成提示词模板，详见下方说明。 |

**预设格式说明：**
- **简单格式**：`名称:提示词`，例如 `动漫风:anime style`
- **高级格式（JSON）**：`名称:{"prompt":"提示词","aspect_ratio":"16:9","resolution":"2K","description":"描述"}`


### 使用示例

#### 基础生图
```
/生图 一只在森林里野餐的兔子
```

#### 使用预设
```
/预设 添加 赛博朋克:cyberpunk style, neon lights, futuristic city
/生图 赛博朋克 猫
```

#### 图生图（引用或 @）
1. 发送或引用一张图片。
2. 输入 `/生图 变成动漫风格[图片][引用消息]`。
或者：
`/生图 变成像素风 @用户A` (将使用用户A的头像作为参考图)

#### 切换模型
```
/生图模型        # 查看列表
/生图模型 2      # 切换到第二个模型
```

### 更新日志

- **v1.0.0-2025-12-28**
  - 首个正式版发布
  - 合并feat/template_list分支

- **#--------BETA--------#**  
(BETA版本更新日志不完整,具体迭代过程可以看提交记录)
- **v0.6.x-2025-12-27**
  - 移除从系统供应商获取配置，由于AstrBot-4.10.0开始修改了供应商逻辑，目前有一些问题，暂时移除该功能
  - 适配#4208的新版配置文件
  - 优化日志系统
  - 拆分main.py
  - 添加任务管理器
  - 添加即梦逆向渠道自动领取积分
  - 其他优化
- **v0.1.0-2025-12-21**
  - 首个beta版本
  - 由 astrbot_plugin_gemini_image 修改而来